<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mapa del mejor baile de nuestras vidas — v8.4</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
:root{ --bg:#0b0d10; --panel:#14181d; --text:#e8edf2; --muted:#9aa4af; --ade:#FFFF07;
       --day1:#F20544; --day2:#F205CB; --day3:#22CCF2; --day4:#A7F205; --border:#2b3138; }
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
header{display:flex;align-items:center;gap:12px;padding:16px 16px 8px} h1{font-size:22px;margin:0;font-weight:900}
.badge-ade{background:var(--ade);color:#000;border-radius:10px;padding:4px 8px;font-weight:900}
.app{display:grid;grid-template-columns:360px 1fr;gap:12px;padding:12px;height:calc(100vh - 70px)}
.sidebar{background:var(--panel);border-radius:20px;padding:14px;overflow:auto;border:1px solid rgba(255,255,255,0.06)}
.mapwrap{background:var(--panel);border-radius:16px;overflow:hidden;position:relative} #map{height:100%;width:100%}
/* Filtros */
.filters{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
.filters .wide{grid-column:1/-1}
.filters button{padding:10px 12px;border-radius:16px;border:2px solid #343c45;background:#0f1317;color:var(--text);font-weight:700;font-size:14px;cursor:pointer;display:flex;align-items:center;gap:6px;justify-content:center}
.filters button .sq{width:8px;height:8px;border-radius:3px;display:inline-block}
.filters button.active{background:var(--ade);color:#000;border:2px solid #343c45;box-shadow:0 0 4px rgba(0,0,0,.4) inset}
/* Lista */
.legend{margin:14px 0 8px;display:flex;align-items:center;gap:8px;opacity:.9; background:#101418; border:1px solid rgba(255,255,255,0.06); padding:6px 10px; border-radius:12px; display:inline-flex}
.legend .sq{width:10px;height:10px;border-radius:3px;display:inline-block}
.venue{display:grid;grid-template-columns:72px 1fr;grid-template-rows:auto auto;grid-template-areas:'dot title' 'dot actions';gap:14px 16px;align-items:center;background:#0f1317;border:1px solid var(--border);border-radius:16px;padding:14px;margin:8px 0}
.dot{grid-area:dot;width:60px;height:60px;border-radius:14px;background:#1b1f25;color:#c6cfda;display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:900}
.dot div:first-child{font-size:18px;line-height:1} .v-title{margin:0;font-weight:900;font-size:18px;line-height:1.15;word-wrap:break-word;overflow-wrap:anywhere}
.v-actions{margin-left:auto;display:flex;gap:10px} .v-actions a,.v-actions button{background:var(--ade);color:#000;padding:9px 14px;border-radius:14px;font-weight:900;text-decoration:none;border:none;cursor:pointer;white-space:nowrap;font-size:14px}
/* Popup refinado (solo pop-up) */
.leaflet-popup-content-wrapper{background:#0f1317;border:2px solid var(--ade);border-radius:16px;color:var(--text)}
.leaflet-popup-content{margin:12px} .pop{min-width:300px; max-width:360px}
.pop-head{display:flex;align-items:center;gap:10px;margin-bottom:2px} .pop-title{margin:0;font-size:18px;font-weight:800;line-height:1.2}
.badge{display:inline-block;background:var(--ade);color:#000;font-weight:900;border-radius:10px;padding:4px 8px}
.pop-day{font-size:12px;opacity:.9;text-transform:uppercase;letter-spacing:.5px;margin-top:2px}
.pop-time{font-size:18px;font-weight:800;margin-top:4px}
.pop-djs{margin-top:8px;font-size:12px;line-height:1.35;opacity:.95; max-height:140px; overflow:auto; padding-right:4px}
.pop-actions{display:flex;gap:8px;margin-top:10px} .pop-actions .btn{background:var(--ade);color:#000;padding:6px 10px;border-radius:10px;font-weight:900;text-decoration:none}
@media (max-width:980px){ .app{grid-template-columns:1fr; height:auto} .mapwrap{height:60vh} }

.venue-item .dot{grid-area:dot;grid-area:dot;width:64px;height:64px;border-radius:16px;background:#1b1f25;color:#c6cfda;display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:900}
.venue-item .dot div:first-child{font-size:20px;line-height:1}
.venue-item .v-body{grid-area:title;display:block}
.venue-item .v-title{margin:0 0 6px 0;font-weight:900;font-size:20px;line-height:1.2;word-break:normal;overflow-wrap:break-word}
.venue-item .v-actions{grid-area:actions;display:flex;gap:10px;flex-wrap:wrap}
.venue-item .v-actions a,.venue-item .v-actions button{background:var(--ade);color:#000;padding:10px 18px;border-radius:24px;font-weight:900;text-decoration:none;border:none;cursor:pointer;white-space:nowrap}
@media (max-width:980px){
  .venue-item{grid-template-columns:64px 1fr;gap:12px 12px;padding:12px;border-radius:18px}
  .venue-item .dot{grid-area:dot;width:58px;height:58px;border-radius:14px}
  .venue-item .v-title{font-size:19px}
  .venue-item .v-actions a,.venue-item .v-actions button{padding:10px 16px;border-radius:20px;font-size:15px}
}


.v-info{grid-area:title}
.v-actions{grid-area:actions}
</style>
  <link rel="manifest" href="manifest.json">
</head>
<body>
<header><span class="badge-ade">ADE</span><h1>Mapa del mejor baile de nuestras vidas</h1></header>
<div class="app">
  <aside class="sidebar">
    <div class="filters">
      <button class="wide active" data-filter="all">Todo ADE</button>
      <button data-filter="day1"><span class="sq" style="background:var(--day1)"></span>Jueves</button>
      <button data-filter="day2"><span class="sq" style="background:var(--day2)"></span>Viernes</button>
      <button data-filter="day3"><span class="sq" style="background:var(--day3)"></span>Sábado</button>
      <button data-filter="day4"><span class="sq" style="background:var(--day4)"></span>Domingo</button>
    </div>
    <div id="list"></div>
  </aside>
  <section class="mapwrap"><div id="map"></div></section>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const HOME = {"name": "Chassé Hotel", "coords": [52.352046143963506, 4.925016840951675]};
const EVENTS = [{"id": "day1-1", "name": "Glitterbox — ADE", "venue": "", "coords": [52.396723592819406, 4.8565205422674715], "day": "day1", "time": "16:00", "end_time": "23:00", "djs": "Cinthie (DE) / Dan Shake (GB) / DJ Holographic (US) / Eats Everything (GB) / Horse Meat Disco (GB) / Kirollus / Makèz (NL) / Melvo Baptiste (GB) / MiNNA (GB) / Mousse T. (DE) / O'Flynn (GB) / Seamus Haji (GB) / Tonno Disko (NL)"}, {"id": "day1-2", "name": "Awakenings x Drumcode", "venue": "", "coords": [52.38488969376688, 4.746322084658673], "day": "day1", "time": "23:00", "end_time": "07:00", "djs": "Adam Beyer (SE) / Bart Skils (NL) / Eli Brown (GB) / Enrico Sangiuliano (IT) / Linska / Marco Faraone (IT)"}, {"id": "day2-1", "name": "Audio Obscura x Metamorfosi [Day]", "venue": "", "coords": [52.328025401340405, 4.91859005582334], "day": "day2", "time": "14:00", "end_time": "23:00", "djs": "Anfisa Letyago (IT) / Ellen Allien (DE) / Joseph Capriati (IT) / KIDOO / Mau P (NL) / Simone Zino / Traumer (FR)"}, {"id": "day2-2", "name": "elrow: Delusionville", "venue": "", "coords": [52.38302274522527, 4.920533913494004], "day": "day2", "time": "23:00", "end_time": "06:00", "djs": "Bastian Bux (ES) / Chelina Manuhutu (NL) B2B Tini Gessler (ES) / Ilario Alicante (IT) / Kevin de Vries (DE) / Prunk (NL) B2B Fleur Shore (UK)"}, {"id": "day3-1", "name": "Mystic Garden / Dockyard Festival", "venue": "", "coords": [52.39256796609656, 4.770634028835332], "day": "day3", "time": "12:00", "end_time": "23:00", "djs": "Alarico (IT) / Amber Broos (BE) / ANNĒ / Bella Claxton (AU) / BIANKA (VE) / Bimini / Chlär (CH) / Chris Avantgarde (GB) / Dax J (GB) / DIØN (NL) / Eli Brown (GB) / Essy / Fafi Abdel Nour (NL) / HI-LO (NL) / Hujus / Jennifer Loveless (AU) / Joran van Pol (NL) / Juicy Romance (AU) / Kyra Khaldi (NL) / LB aka LABAT (FR) / Malugi (DE) / Moody Mehran (NL) / Narciss (DE) / Partiboi69 (AU) / Rayzir (NL) / SHDW / VE/RA / Young Marco (NL)"}, {"id": "day4-1", "name": "Audio Obscura @ The Loft [Sunset]", "venue": "", "coords": [52.38389216507223, 4.902215508801694], "day": "day4", "time": "15:00", "end_time": "22:00", "djs": "TBA"}, {"id": "day4-2", "name": "Madam invites MVSON", "venue": "", "coords": [52.38389216507223, 4.902215508801694], "day": "day4", "time": "22:00", "end_time": "05:00", "djs": "FLETCH (GB) / Mason Collective (GB) / Rayzir (NL)"}];
const USER_GMAPS = {"glitterbox — ade": "https://maps.app.goo.gl/jUH8Ev2VZwhzB8cZ6", "awakenings x drumcode": "https://maps.app.goo.gl/7nRP5yEmDLDYKZGh8", "audio obscura x metamorfosi [day]": "https://maps.app.goo.gl/qz7ERyVtaW4gxNEd6", "elrow: delusionville": "https://maps.app.goo.gl/ziiDqtmHHA9dkqAV9", "mystic garden / dockyard festival": "https://maps.app.goo.gl/1D5VRBHXr1SCr3Jo6", "audio obscura @ the loft [sunset]": "https://maps.app.goo.gl/6ggsQhBQzB1JBc2Y7", "madam invites mvson": "https://maps.app.goo.gl/6ggsQhBQzB1JBc2Y7"};
const dayColors = {day1:"var(--day1)", day2:"var(--day2)", day3:"var(--day3)", day4:"var(--day4)"};
function dayLabel(k){return {"day1": "Jueves", "day2": "Viernes", "day3": "Sábado", "day4": "Domingo"}[k] || k;}
function numberIcon(n, color){return L.divIcon({className:'',html:`<div style="background:rgba(0,0,0,.35);box-shadow:0 0 0 2px #000, 0 0 0 4px rgba(255,255,255,0.08);border:3px solid ${color};color:${color};width:38px;height:38px;display:flex;align-items:center;justify-content:center;border-radius:12px;font-weight:900">${n}</div>`,iconSize:[38,38],iconAnchor:[19,19],popupAnchor:[0,-14]});}

const map = L.map('map', { zoomControl:true }).setView([52.3728, 4.8936], 12);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {attribution:'&copy; OpenStreetMap & CARTO'}).addTo(map);

const groups = {day1:L.layerGroup().addTo(map),day2:L.layerGroup().addTo(map),day3:L.layerGroup().addTo(map),day4:L.layerGroup().addTo(map)};

// --- helpers to separate overlapping markers (same lat/lng) ---
function metersToDegreeLat(m){ return m / 111111; }
function metersToDegreeLng(m, lat){ return m / (111111 * Math.cos(lat * Math.PI/180)); }
function offsetLatLng(latlng, angleDeg, radiusM){
  const dLat = metersToDegreeLat(radiusM) * Math.sin(angleDeg * Math.PI/180);
  const dLng = metersToDegreeLng(radiusM, latlng[0]) * Math.cos(angleDeg * Math.PI/180);
  return [latlng[0] + dLat, latlng[1] + dLng];
}


// numeración por día (hotel = 1, eventos desde 2 según hora)
const seqIndex = {};
['day1','day2','day3','day4'].forEach(day => {
  const dayEvents = EVENTS.filter(e=>e.day===day).sort((a,b)=>a.time.localeCompare(b.time));
  let n=2; dayEvents.forEach(ev => { seqIndex[ev.id]=n++; });
});

// hotel por día

Object.keys(groups).forEach(day=>{
  const evs = EVENTS.filter(e=>e.day===day).sort((a,b)=>a.time.localeCompare(b.time));
  if(!evs.length) return;
  const coords = [HOME.coords];

  // Group events by identical coordinates (rounded)
  const sameSpot = {};
  evs.forEach(ev=>{
    const key = ev.coords[0].toFixed(6)+","+ev.coords[1].toFixed(6);
    (sameSpot[key] ||= []).push(ev);
  });

  evs.forEach(ev=>{
    const key = ev.coords[0].toFixed(6)+","+ev.coords[1].toFixed(6);
    const bucket = sameSpot[key];
    let markerPos = ev.coords;

    if (bucket && bucket.length > 1) {
      // Spread evenly on a ring. For 2 items: 0° and 180°. Radius 32m.
      const idx = bucket.findIndex(x=>x.id===ev.id);
      const total = bucket.length;
      const base = (total === 2) ? [0,180][idx] : (360/total)*idx;
      markerPos = offsetLatLng(ev.coords, base, 32);
    }

    const n = seqIndex[ev.id]||'?';
    const m = L.marker(markerPos, {icon:numberIcon(n, dayColors[day]), riseOnHover:true}).addTo(groups[day]);
    bindPopupWithStyle(m, ev, n, day);
    coords.push(ev.coords); // use true coords for route
  });

  coords.push(HOME.coords);
  L.polyline(coords, {color:dayColors[day], weight:4, opacity:.95}).addTo(groups[day]);
});


// === POPUP (solo cambio de layout) ===
function bindPopupWithStyle(layer, evOrHome, n, dayKey) {
  const wrap = document.createElement('div'); wrap.className='pop';
  const head = document.createElement('div'); head.className='pop-head';
  head.innerHTML = `<span class="badge">${n}</span><h1 class="pop-title">${evOrHome.name || ''}</h1>`; wrap.appendChild(head);
  const dayLine = document.createElement('div'); dayLine.className='pop-day'; dayLine.textContent = evOrHome.day ? dayLabel(evOrHome.day) : ''; wrap.appendChild(dayLine);
  const timeLine = document.createElement('div'); timeLine.className='pop-time'; const start=evOrHome.time||''; const end = evOrHome.end_time ? ` – ${evOrHome.end_time}` : ''; timeLine.textContent = `${start}${end}`; wrap.appendChild(timeLine);
  if (evOrHome.djs) { const d=document.createElement('div'); d.className='pop-djs'; d.textContent=evOrHome.djs; wrap.appendChild(d);}
  const actions = document.createElement('div'); actions.className='pop-actions';
  if (evOrHome.name) { const key=(evOrHome.name||'').toLowerCase(); const link = USER_GMAPS[key] || (evOrHome.coords ? `https://www.google.com/maps/dir/?api=1&origin=${HOME.coords[0]},${HOME.coords[1]}&destination=${evOrHome.coords[0]},${evOrHome.coords[1]}` : '#'); const a=document.createElement('a'); a.href=link; a.target='_blank'; a.rel='noopener'; a.className='btn'; a.textContent='Ruta'; actions.appendChild(a);}
  wrap.appendChild(actions); layer.bindPopup(wrap);
}

// === Lista lateral (dos botones, uno centra y otro abre tu link exacto) ===
const list = document.getElementById('list');
function renderList(filter='all') {
  list.innerHTML='';
  const days = filter==='all' ? ['day1','day2','day3','day4'] : [filter];
  days.forEach(day=>{
    const evs = EVENTS.filter(e=>e.day===day).sort((a,b)=>a.time.localeCompare(b.time));
    if(!evs.length) return;
    const head = document.createElement('div'); head.className='legend';
    head.innerHTML = `<span class="sq" style="background:${dayColors[day]}"></span> <strong>${dayLabel(day)}` + `</strong>`; list.appendChild(head);
    evs.forEach(ev=>{
      const wrap = document.createElement('div'); wrap.className='venue'; wrap.dataset.id=ev.id;
      const dot = document.createElement('div'); dot.className='dot'; dot.innerHTML=`<div>${seqIndex[ev.id]||'-'}</div><div>${ev.time||'--:--'}` + `</div>`;
      const info = document.createElement('div'); info.className='v-info'; const title = document.createElement('p'); title.className='v-title'; title.textContent = ev.name; info.appendChild(title);
      const actions = document.createElement('div'); actions.className='v-actions';
      const b1=document.createElement('button'); b1.textContent='Ver en mapa'; b1.onclick=()=>map.setView(ev.coords,14);
      const b2=document.createElement('a'); b2.textContent='Ruta'; b2.target='_blank'; b2.rel='noopener'; const key=ev.name.toLowerCase(); b2.href = USER_GMAPS[key] || `https://www.google.com/maps/dir/?api=1&origin=${HOME.coords[0]},${HOME.coords[1]}&destination=${ev.coords[0]},${ev.coords[1]}`;
      actions.appendChild(b1); actions.appendChild(b2);
      wrap.appendChild(dot); wrap.appendChild(info); wrap.appendChild(actions); list.appendChild(wrap);
    });
  });
}
renderList('all');

// Filtros
document.querySelectorAll('.filters button').forEach(btn=>{
  btn.addEventListener('click',()=>{ 
    document.querySelectorAll('.filters button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const f = btn.getAttribute('data-filter');
    renderList(f);
    Object.keys(groups).forEach(k=>{ if (f==='all' || k===f) groups[k].addTo(map); else map.removeLayer(groups[k]); });
  });
});
</script>

<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", ()=>{ navigator.serviceWorker.register("./service-worker.js"); });
}
</script>
</body>
</html>
